<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<title>å­—æ ¹æ‰“å­—ç·´ç¿’</title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&display=swap" rel="stylesheet">
<style>
* { box-sizing: border-box; font-family: 'Noto Sans TC', sans-serif; }
body {
  margin: 0; width: 100vw; height: 100vh;
  background: radial-gradient(circle at top, #0f172a, #020617);
  color: #e5e7eb;
  display: flex; justify-content: center; align-items: center;
  overflow: hidden;
}
.container {
  display: flex; gap: 32px;
  flex-wrap: wrap; justify-content: center; align-items: flex-start;
  padding: 20px;
}
.stage {
  background: rgba(15,23,42,0.95);
  border-radius: 24px;
  padding: 36px 48px;
  min-width: 520px;
  box-shadow: 0 20px 60px rgba(0,0,0,0.6);
  display: flex; flex-direction: column;
  align-items: center;
  transition: all 0.3s;
}
header { display: flex; gap: 16px; margin-bottom: 16px; }
select, button {
  padding: 10px 18px;
  border-radius: 12px;
  border: none;
  font-size: 1rem;
  cursor: pointer;
  transition: all 0.3s;
}
select { background: #1e293b; color: #e5e7eb; }
button { background: linear-gradient(90deg,#38bdf8,#0ea5e9); color: #020617; font-weight: 700; }
button:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(56,189,248,0.5); }

.roots {
  display: grid;
  grid-template-columns: repeat(16, 1fr);
  grid-auto-rows: 70px;
  gap: 12px;
  font-size: 2.5rem;
  margin-bottom: 20px;
  justify-items: center;
  align-items: center;
}
.root { opacity: 0.3; transition: all 0.3s; border-radius:8px; padding:4px; }
.root.active { opacity: 1; color: #38bdf8; text-shadow:0 0 12px #38bdf8; transform: scale(1.3); position: relative; }
.root.active::after { content: ""; position: absolute; left: 0; right: 0; bottom: -6px; height: 3px; background: #38bdf8; animation: blink 1s infinite; }
.root.done { opacity: 1; color: #4ade80; text-shadow:0 0 10px #4ade80; }

input {
  font-size: 2rem;
  padding: 16px 24px;
  width: 360px; max-width: 90%;
  display: block; margin: 0 auto;
  text-align: center;
  border-radius: 20px; border: 2px solid #38bdf8;
  outline: none;
  background: #0f172a; color: #f0f9ff;
  transition: all 0.3s;
}
input::placeholder { color: #94a3b8; opacity: 1; }
input:focus { box-shadow:0 0 15px #38bdf8; border-color:#60a5fa; }
input.error { animation: shake 0.15s; border-color:#dc2626; box-shadow:0 0 10px #dc2626; }
@keyframes shake { 0%{transform:translateX(0);}25%{transform:translateX(-5px);}50%{transform:translateX(5px);}75%{transform:translateX(-5px);}100%{transform:translateX(0);} }

.info { margin-top:12px; font-size:1.1rem; display:flex; gap:20px; flex-wrap:wrap; justify-content:center; }
.info span { font-weight:700; color:#38bdf8; }

.tips { width:280px; background: rgba(30,41,59,0.85); border-radius:20px; padding:24px; box-shadow:0 12px 40px rgba(0,0,0,0.5); }
.tips h3 { margin-top:0; color:#7dd3fc; }
.tips li { margin-bottom:12px; line-height:1.5; }

@media(max-width:1200px){ .roots { grid-template-columns: repeat(8, 1fr); } }
@media(max-width:800px){ .roots { grid-template-columns: repeat(4, 1fr); } .stage{ min-width:320px; } .tips{ width:90%; } }

.confetti { pointer-events:none; position:fixed; top:0; left:0; width:100%; height:100%; overflow:hidden; z-index:9999; }

.stats-panel {
  width:360px; max-width:90%;
  margin-top:16px;
  background: rgba(30,41,59,0.85);
  border-radius:16px;
  padding:12px 20px;
  font-size:1rem;
  color:#f0f9ff;
  display:flex; justify-content:space-between;
  flex-wrap:wrap;
  gap:8px;
}

.progress-container {
  width:360px; max-width:90%;
  background:#1e293b;
  border-radius:12px;
  height:16px;
  margin-top:12px;
  overflow:hidden;
}
.progress-bar {
  height:100%;
  width:0%;
  background: linear-gradient(90deg,#38bdf8,#0ea5e9);
  border-radius:12px;
  transition: width 0.3s ease;
}
</style>
</head>

<body>
<div class="container">

  <div class="stage">
    <header>
      <select id="level"></select>
      <button id="restart">é‡æ–°é–‹å§‹</button>
    </header>

    <div id="roots" class="roots"></div>

    <input id="input" placeholder="è¼¸å…¥å­—æ ¹å¾ŒæŒ‰ç©ºç™½éµ" autocomplete="off">

    <div class="info">
      â± æ™‚é•·ï¼š<span id="time">0.0</span> ç§’
      âœ… æ­£ç¢ºï¼š<span id="correct">0</span>/<span id="total">0</span>
    </div>

    <div class="stats-panel">
      <span>æ­£ç¢ºç‡ï¼š<span id="accuracy">0%</span></span>
      <span>å¹³å‡æ¯å­—å˜—è©¦ï¼š<span id="avg">0</span></span>
      <span>WPMï¼š<span id="wpm">0</span></span>
    </div>

    <div class="progress-container">
      <div id="progress-bar" class="progress-bar"></div>
    </div>
  </div>

  <aside class="tips">
    <h3>ğŸ’¡ å° Tips</h3>
    <ul>
      <li>è«‹ç¢ºèªåˆ‡æ›è‡³<br><b>ä¸­æ–‡é€Ÿæˆè¼¸å…¥æ³•</b></li>
      <li>è¼¸å…¥å¾Œéœ€æŒ‰<br><b>ç©ºç™½éµ</b></li>
      <li>å®Œæˆå¾Œ<br>ğŸ™‹ è«‹èˆ‰æ‰‹ç¤ºæ„è€å¸«</li>
    </ul>
  </aside>

</div>

<canvas id="confetti" class="confetti"></canvas>

<script>
/* ===== éŸ³æ•ˆ ===== */
const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
function playTone(freq,dur,type,vol){
  const o=audioCtx.createOscillator();
  const g=audioCtx.createGain();
  o.type=type; o.frequency.value=freq; g.gain.value=vol;
  o.connect(g); g.connect(audioCtx.destination);
  o.start(); o.stop(audioCtx.currentTime+dur);
}
const soundCorrect = ()=>playTone(880,.12,"triangle",.1);
const soundWrong = ()=>playTone(220,.15,"square",.08);

/* ===== å­—æ ¹è¨­å®š ===== */
const levels={
  "1. å“²ç†é¡":["æ—¥","æœˆ","é‡‘","æœ¨","æ°´","ç«","åœŸ"],
  "2. ç­†åŠƒé¡":["ç«¹","æˆˆ","å","å¤§","ä¸­","ä¸€","å¼“"],
  "3. äººé«”é¡":["äºº","å¿ƒ","æ‰‹","å£"],
  "4. å­—å½¢é¡":["å°¸","å»¿","å±±","å¥³","ç”°","åœ"],
  "5. æ··åˆä¸»é¡Œ":["æ—¥","æœˆ","é‡‘","æœ¨","æ°´","ç«","åœŸ","ç«¹","æˆˆ","å","å¤§","ä¸­","ä¸€","å¼“","äºº","å¿ƒ","æ‰‹","å£","å°¸","å»¿","å±±","å¥³","ç”°","åœ"]
};

/* ===== å·¥å…· ===== */
function shuffleArray(arr){ return arr.slice().sort(()=>Math.random()-0.5); }
function buildRoots(base){
  const r=[];
  while(r.length<32){
    const next=base[Math.floor(Math.random()*base.length)];
    r.push(next);
  }
  return r;
}

/* ===== DOM ===== */
const levelSel=document.getElementById("level");
const rootsEl=document.getElementById("roots");
const inputEl=document.getElementById("input");
const timeEl=document.getElementById("time");
const correctEl=document.getElementById("correct");
const totalEl=document.getElementById("total");
const accuracyEl=document.getElementById("accuracy");
const avgEl=document.getElementById("avg");
const wpmEl=document.getElementById("wpm");
const progressBar=document.getElementById("progress-bar");

/* ===== ç‹€æ…‹ ===== */
let roots=[], index=0, startTime=null, animationFrame=null;
let correctCount=0, totalAttempts=0;
let finished=false;

/* ===== åˆå§‹åŒ–é—œå¡é¸å–® ===== */
Object.keys(levels).forEach(k=>{
  const o=document.createElement("option");
  o.textContent=o.value=k;
  levelSel.appendChild(o);
});

/* ===== æ¸²æŸ“å­—æ ¹èˆ‡é€²åº¦æ¢ ===== */
function render(){
  rootsEl.innerHTML="";
  roots.forEach((r,i)=>{
    const s=document.createElement("span");
    s.textContent=r;
    s.className="root";
    if(i<index) s.classList.add("done");
    if(i===index) s.classList.add("active");
    rootsEl.appendChild(s);
  });
  const progress=((index)/roots.length)*100;
  progressBar.style.width=(index>=roots.length?100:progress)+"%";
}

/* ===== é‡ç½® ===== */
function reset(){
  audioCtx.resume();
  finished=false;
  roots=buildRoots(levels[levelSel.value]);
  index=0; startTime=null;
  cancelAnimationFrame(animationFrame);
  correctCount=0; totalAttempts=0;
  timeEl.textContent="0.0";
  correctEl.textContent=correctCount;
  totalEl.textContent=totalAttempts;
  accuracyEl.textContent="0%";
  avgEl.textContent="0";
  wpmEl.textContent="0";
  progressBar.style.width="0%";
  inputEl.value="";
  inputEl.classList.remove("error");
  render();
  inputEl.focus();

  // âœ… å•Ÿå‹•è¨ˆæ™‚å¾ªç’°
  animationFrame = requestAnimationFrame(updateStats);
}

/* ===== é™åˆ¶è¼¸å…¥ä¸€å€‹å­— ===== */
let composing=false;
inputEl.addEventListener("compositionstart",()=>composing=true);
inputEl.addEventListener("compositionend",(e)=>{
  composing=false;
  checkInput(e.target.value.trim());
  inputEl.value="";
});
inputEl.addEventListener("input",()=>{
  if(!composing && inputEl.value.length>1) inputEl.value=inputEl.value.slice(-1);
});

/* ===== é©—è­‰è¼¸å…¥ ===== */
function checkInput(v){
  if(!v || finished) return;
  totalAttempts++;
  if(!startTime) startTime=Date.now();

  if(v===roots[index]){
    correctCount++;
    soundCorrect();
    inputEl.classList.remove("error");
    index++;
    render();
    if(index>=roots.length){
      finished=true;
      launchConfetti();
      cancelAnimationFrame(animationFrame);
      setTimeout(()=>{
        const accPercent=((correctCount/totalAttempts)*100).toFixed(1);
        const avgPerChar=(totalAttempts/roots.length).toFixed(2);
        const elapsedMin=(Date.now()-startTime)/1000/60;
        const wpmFinal=(correctCount/elapsedMin).toFixed(1);
        alert(`ğŸ‰ æ­å–œå®Œæˆæ‰“å­—ç·´ç¿’ï¼
æ­£ç¢ºç‡ï¼š${correctCount}/${totalAttempts} (${accPercent}%)
å¹³å‡æ¯å­—å˜—è©¦æ¬¡æ•¸ï¼š${avgPerChar}
æ‰“å­—é€Ÿåº¦ WPMï¼š${wpmFinal}
è«‹èˆ‰æ‰‹ç¤ºæ„è€å¸«ï¼`);
      },300);
    }
  } else {
    soundWrong();
    inputEl.classList.add("error");
    setTimeout(()=>inputEl.classList.remove("error"),150);
  }

  correctEl.textContent=correctCount;
  totalEl.textContent=totalAttempts;
  accuracyEl.textContent=((correctCount/totalAttempts)*100).toFixed(1)+"%";
  avgEl.textContent=(totalAttempts/roots.length).toFixed(2);
}

/* ===== ç©ºç™½éµç¢ºèª ===== */
inputEl.addEventListener("keydown",e=>{
  if(!composing && e.key===" "){
    e.preventDefault();
    checkInput(inputEl.value.trim());
    inputEl.value="";
  }
});

/* ===== è¨ˆæ™‚èˆ‡ WPM ===== */
function updateStats(){
  if(!startTime || finished){
    animationFrame = requestAnimationFrame(updateStats); // ç¡®ä¿å¾ªç¯ç»§ç»­
    return;
  }
  const elapsedSec=(Date.now()-startTime)/1000;
  timeEl.textContent=elapsedSec.toFixed(1);
  const wpm=(correctCount/(elapsedSec/60)).toFixed(1);
  wpmEl.textContent=wpm;
  animationFrame=requestAnimationFrame(updateStats);
}

/* ===== é—œå¡åˆ‡æ› & é‡ç½® ===== */
levelSel.onchange=reset;
document.getElementById("restart").onclick=reset;

/* ===== åˆå§‹åŒ– ===== */
reset();

/* ===== Confetti ç²’å­æ•ˆæœï¼ˆä¸å˜ï¼Œå¯ä¿æŒåŸæœ‰ä»£ç ï¼‰ ===== */


/* ===== Confetti ç²’å­æ•ˆæœ ===== */
const canvas=document.getElementById("confetti");
const ctx=canvas.getContext("2d");
let confettis=[];
function resizeCanvas(){ canvas.width=window.innerWidth; canvas.height=window.innerHeight; }
window.addEventListener("resize",resizeCanvas);
resizeCanvas();

function createConfetti(){
  confettis=[];
  for(let i=0;i<150;i++){
    confettis.push({
      x:Math.random()*canvas.width,
      y:Math.random()*canvas.height - canvas.height,
      r:Math.random()*6+4,
      d:Math.random()*20+10,
      color:`hsl(${Math.random()*360},100%,50%)`,
      tilt:Math.random()*10-10,
      tiltAngleIncrement:Math.random()*0.07+0.05,
      tiltAngle:0
    });
  }
}

function drawConfetti(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  confettis.forEach((c,i)=>{
    ctx.beginPath();
    ctx.lineWidth=c.r/2;
    ctx.strokeStyle=c.color;
    ctx.moveTo(c.x+c.tilt+ c.r/4, c.y);
    ctx.lineTo(c.x+c.tilt, c.y+c.tilt+c.r/2);
    ctx.stroke();
    c.tiltAngle+=c.tiltAngleIncrement;
    c.y+=(Math.cos(c.d)+3+c.r/2)/2;
    c.x+=Math.sin(c.d);
    c.tilt=Math.sin(c.tiltAngle)*15;
    if(c.y>canvas.height){ confettis.splice(i,1); }
  });
  if(confettis.length>0) requestAnimationFrame(drawConfetti);
}

function launchConfetti(){ createConfetti(); drawConfetti(); }
</script>
</body>
</html>
